#!/usr/bin/env groovy

properties([
    parameters(
        [
        string(defaultValue: "https://github.com/fnJustin/gtest.git", description: 'git repo to pull', name: 'REPO'),
        string(defaultValue: "osx", description: 'node label that is valid for', name: 'NODELABEL'),
        string(defaultValue: "vfx18_mac_Release", description: 'profile', name: 'PROFILE'),
        string(defaultValue: "./src", description: 'conan py file location in repo', name: 'CONAN_PY_LOC'),
        string(defaultValue: "--build=missing", description: 'pass in another option to the build --build=missing etc', name: 'CONAN_INSTALL_OPTIONS'),
        ]
    )
])

node("${NODELABEL}"){
    withEnv(["PATH=/usr/local/bin/:$PATH:/Applications/CMake.app/Contents/bin"]) {

        stage("SCM ${NODELABEL}") {
            //clean out old build
            sh "rm -rf *"
            git "${REPO}"
        }

        stage ("Conan install ${NODELABEL}"){
            //get dependencies
            sh "mkdir build"
            sh "conan install ${CONAN_PY_LOC} --install-folder=./build --profile=${PROFILE} ${CONAN_INSTALL_OPTIONS}"
        }

        stage("Conan Build ${NODELABEL}") {
            sh "conan build ${CONAN_PY_LOC} --build-folder=./build"
        }

        stage("UnitTests ${NODELABEL}") {
            sh "cd build && ./tests --gtest_output=xml:tests.xml"
            junit '**/build/tests.xml'
            sh "cd build && gcov ../src/*.cpp --object-directory CMakeFiles/tests.dir/"
            sh "gcovr -r . -x --object-directory=build >coverage.xml"

        }

        stage("Analysis ${NODELABEL}") {
            sh "cppcheck --xml --xml-version=2 --enable=all 2>cppcheck.xml ./src"
        }

    }//env

}//node
