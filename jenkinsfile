#!/usr/bin/env groovy

node("${NODELABEL}"){
    withEnv(["PATH=/usr/local/bin/:$PATH:/Applications/CMake.app/Contents/bin"]) {

        stage("SCM ${NODELABEL}") {
            //clean out old build
            sh "rm -rf *"
            git "${REPO}"
        }

        stage ("Conan ${NODELABEL}"){
            //get dependencies
            sh "mkdir build"
            if (fileExists('./src/conanfile.txt')) {
                sh "cd build && conan install ../src"
            }
        }

        stage("CMake ${NODELABEL}") {
            sh "cd build && cmake ../src"
        }

        stage("Build ${NODELABEL}") {
            sh "cd build && make"
        }

        stage("UnitTests ${NODELABEL}") {
            sh "cd build && ./tests --gtest_output=xml:tests.xml"
            junit '**/build/tests.xml'
            sh "cd build && gcov ../src/*.cpp --object-directory CMakeFiles/tests.dir/"
            sh "gcovr -r . -x --object-directory=build >coverage.xml"

        }

        stage("Analysis ${NODELABEL}") {
            sh "cppcheck --xml --xml-version=2 --enable=all 2>cppcheck.xml ./src"
        }

    }//env

}//node
