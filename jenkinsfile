#!/usr/bin/env groovy

node("${NODELABEL}"){
    withEnv(["PATH=/usr/local/bin/:$PATH:/Applications/CMake.app/Contents/bin"]) {

        stage("SCM ${NODELABEL}") {
            //clean out old build
            sh "rm -rf *"
            git "${REPO}"
        }

        stage ("Conan install ${NODELABEL}"){
            //get dependencies
            sh "mkdir build"
            sh "conan install . --install-folder=./build --profile=${PROFILE}"
        }

        stage("Conan Build ${NODELABEL}") {
            sh "conan build . --build-folder=./build"
        }

        stage("UnitTests ${NODELABEL}") {
            sh "cd build && ./tests --gtest_output=xml:tests.xml"
            junit '**/build/tests.xml'
            sh "cd build && gcov ../src/*.cpp --object-directory CMakeFiles/tests.dir/"
            sh "gcovr -r . -x --object-directory=build >coverage.xml"

        }

        stage("Analysis ${NODELABEL}") {
            sh "cppcheck --xml --xml-version=2 --enable=all 2>cppcheck.xml ./src"
        }

    }//env

}//node
